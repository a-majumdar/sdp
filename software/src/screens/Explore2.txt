import React, { useContext, useRef, useState } from "react";
import Cards from "../components/organisms/expCards";
import Footer from "../components/organisms/Footer";
import { Card, Form, Alert } from "react-bootstrap";
import { useHistory } from "react-router-dom";
import PlantBackground from "../assets/explr.jpg";
import neo4j from "neo4j-driver";
import { Button } from "../components/atoms/Button";
import { Link, useLocation } from "react-router-dom";
import { PlantDataContext } from "../contexts/PlantDataContext";
import "./Explore.css";

/**
 * Explore section of our website
 * @returns
 */
export default function Explore() {
  const uri = "neo4j+s://28cce6ce.databases.neo4j.io";
  const user = "neo4j";
  const password = "sdpgroup22isthebest";
  const driver = neo4j.driver(uri, neo4j.auth.basic(user, password));
  const session = driver.session();
  const session2 = driver.session();
  const history = useHistory();
  const [theUserSearch, setUserSearch] = useState("");

  const {
    plantName,
    setPlantName,
    setHigherNode,
    setPhLow,
    setTempLow,
    setPhHigh,
    setMoistureType,
    tempHigh,
    setTempHigh,
    setLight,
    setWatering,
    setHumidity,
    setCommonName,
    plantDescription,
    setPlantDescription,
    plantIdAura,
    setPlantIdAura,
    higherNode,
    commonName,
    moistureType,
    watering,
    light,
    humidity,
    phHigh,
    tempLow,
    pHLow,
  } = useContext(PlantDataContext);

  const routeChange = () => {
    let path = `/SearchPage`;
    history.push(path);
  };

  function search(word) {
    try {
      console.log("Debug Test Explore Page (Search Function)");
      //step1: searching the plant name by its common name or (professional) name
      //step2:retrun all plant details (later will also with propogator conditions as it establlished manaully)
      //eg: when we search tomato, it would return all the palnts which has the common/professional name called tomato with their all relevant information

      const readQuery = `match (n:Species)-[:In]-> (p) -[:In]->(l) -[:In] ->(z) -[:In]->(k) -[:In]->(q) 
                      where n.common = $search or n.name = $search
                       return n.name as plant,n.common as common, n.description as description, n.information as info,p.name as a,l.name as b,z.name as c ,k.name as d,q.name as e,n.moisture_type as f,n.watering as g, n.light as h,n.temp_high as i, n.humidity as j, n.pH_high as k, n.temp_low as l, n.pH_low as m`;

      const AnanyaQuery = `
      MATCH (n)
      WHERE n.common = $search or n.name = $search
      RETURN 
        ID(n) AS plantID,
        n.name AS plant,
        n.common AS common,
        n.description AS description, 
        n.humidity AS humidity,
        n.light AS light,
        n.moisture_type AS moisture_type, 
        n.pH_high AS upper_pH,
        n.pH_low AS lower_pH,
        n.temp_high AS upper_temp,
        n.temp_low AS lower_temp, 
        n.watering AS watering_style`;
      session2.readTransaction((tx) =>
        tx.run(AnanyaQuery, { search: word }).then((readResult) => {
          readResult.records.forEach((record) => {
            console.log(`plant name: ${record.get("plant")}`);
            setPlantName(`plant name: ${record.get("plant")}`); //Here, I'm just setting constants equal to what we are getting from the AuraDb database so that we can then pass these as props to whichever class we need them in.
            // console.log(plantName);
            // console.log(`in: ${record.get("a")}`);
            //setHigherNode(record.get("a"));
            setPlantIdAura(record.get("plantID").low);
            console.log(record.get("plantID").low);
            //NEED TO CHNAGE THIS TO GET THE ID OF THE QUERIED PLANT IN SEARCH

            // console.log(`is: ${record.get("common")}`);
            setCommonName(record.get("common"));
            setPlantDescription(record.get("description"));

            // console.log(`with: ${record.get("info")}`);
            setHumidity(`Humidity is: ${record.get("humidity")}`);

            setWatering(`Watering is: ${record.get("watering_style")}`);
            setLight(`Light is: ${record.get("light")}`);
            setTempHigh(`Temp High is: ${record.get("upper_temp")}`);
            setMoistureType(`Moisture Type is: ${record.get("moisture_type")}`);
            setPhHigh(`pH High Is: ${record.get("upper_pH")}`);
            setTempLow(`Temp Low is: ${record.get("lower_temp")}`);
            setPhLow(`pH Low is: ${record.get("lower_pH")}`);
          });
        })
      );
    } catch (error) {
      console.error("Something went wrong: ", error);
    }
  }
  return (
    <>
      <div className="hero-container3">
        <img className="background-image" src={PlantBackground}></img>
        <h1 style={{ color: "#3D3939", fontSize: 80 }}>Explore new plants!</h1>
        <Form>
          <input
            className="search-bar"
            type="text"
            required
            value={theUserSearch}
            onChange={(e) => setUserSearch(e.target.value)}
          />
          <Link to={`/SearchPage`}>
            <button
              className="search-btn"
              type="submit"
              onClick={search(theUserSearch)}
            >
              {""}
              {/*This should be working if you go into console on the website and type "Tomato"*/}
              Search
            </button>{" "}
          </Link>
          {/* onclick of this button go to search result page */}
        </Form>
        {/* {
          theUserSearch = userSearch
        } */}

        <div className="hero-btns2"></div>
      </div>
      <Cards />
      <Footer />
    </>
  );
}